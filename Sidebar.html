<!doctype html>
<html>
  <head>
    <base target="_top" />
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css" />
    <style>
      .hidden {
        display: none;
      }
      .m-1 {
        margin: 0.25rem;
      }
      .m-2 {
        margin: 0.5rem;
      }
      .m-3 {
        margin: 0.75rem;
      }
      .p-1 {
        padding: 0.25rem;
      }
      .overflow-y-scroll {
        overflow-y: scroll;
      }
      .h-56 {
        max-height: 14rem;
      }
    </style>
  </head>
  <body class="m-3">
    <div id="yt-container">
      <div>
        <p>
          User:<b> <span class="user-email">...</span></b>
        </p>
        <p>
          Channel:<b> <span class="channel">...</span></b>
        </p>
        <p><b>Note:</b> You can only login in your personal YouTube Channel. The script won't work with branded channels to which you have access.</p>
        <hr />
        <button onclick="scheduleYouTubeBroadcasts()" class="action">Schedule Selected Rows</button>
        <p>If you leave year, month, day, or hour empty it will use the current date.</p>
        <br />
        <hr />
        <button onclick="updateStreamKeys()" class="action">Update Stream Keys</button>
        <p>If you update your stream keys use this button.</p>
        <br />
        <hr />
      </div>

      <p><b>Logs</b></p>
      <div class="logs h-56 overflow-y-scroll"></div>
    </div>

    <script>
      const ytElem = document.getElementById('yt-container');

      function updateStreamKeys() {
        showResponse('Updating YouTube stream keys...');
        google.script.run
          .withSuccessHandler((msg) => showResponse(msg))
          .withFailureHandler((e) => showError(e))
          .updateStreamKeys();
      }

      function scheduleYouTubeBroadcasts() {
        showResponse('Scheduling YouTube Broadcasts...');
        google.script.run
          .withSuccessHandler((msg) => showResponse(msg))
          .withFailureHandler((e) => showError(e))
          .scheduleBroadcasts();
      }

      function showResponse(value, isError = false, time = Date.now()) {
        const logs = document.querySelector('.logs');
        const timestamp = new Date(time).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' });

        logs.innerHTML =
          `<p class="${isError ? 'error' : ''}">
                <span class="secondary">[${timestamp}]</span>
                ${escapeHtml(value)}
            </p><hr />` + logs.innerHTML;
      }

      function showError(msg) {
        showResponse(msg, true);
      }

      function escapeHtml(str) {
        return new Option(String(str)).innerHTML;
      }

      google.script.run
        .withSuccessHandler((email) => {
          ytElem.querySelector('.user-email').textContent = email;
        })
        .withFailureHandler((e) => showError(e))
        .getUserEmail();

      google.script.run
        .withSuccessHandler((channel) => {
          ytElem.querySelector('.channel').textContent = channel.title;
        })
        .withFailureHandler((e) => showError(e))
        .getMyChannel();
    </script>
  </body>
</html>
